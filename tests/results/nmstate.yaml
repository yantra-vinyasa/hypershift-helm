---
apiVersion: v1
kind: Namespace
metadata:
  name: "r6-ocp-virt01"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hypershift-installer
  namespace: "r6-ocp-virt01"
---
apiVersion: v1
kind: Secret
metadata:
  name: "r6-ocp-virt01-sshkey"
  namespace: "r6-ocp-virt01"
data:
  id_rsa.pub: "c3NoLXJzYSAuLi4="
type: Opaque
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: capi-provider-role
  namespace: "r6-ocp-virt01"
rules:
  - apiGroups:
      - agent-install.openshift.io
    resources:
      - agents
    verbs:
      - "*"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: hypershift-installer-role
  namespace: "r6-ocp-virt01-r6-ocp-virt01"
  annotations:
    helm.sh/hook-weight: "30"
rules:
  - apiGroups: [""]
    resources:
      - services
    verbs:
      - get
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: hypershift-installer-binding
  namespace: "r6-ocp-virt01-r6-ocp-virt01"
  annotations:
    helm.sh/hook-weight: "30"
subjects:
  - kind: ServiceAccount
    name: hypershift-installer
    namespace: "r6-ocp-virt01"
roleRef:
  kind: Role
  name: hypershift-installer-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: metal3.io/v1alpha1
kind: BareMetalHost
metadata:
  name: "r6-ocp-virt01-w03"
  namespace: "r6-ocp-virt01"
  annotations:
    bmac.agent-install.openshift.io/role: "worker"
    bmac.agent-install.openshift.io/hostname: "r6-ocp-virt01-w03"
    helm.sh/hook-weight: "15"
  labels:
    infraenvs.agent-install.openshift.io: "worker"
spec:
  bootMode: "UEFI"
  bmc:
    address: "redfish-virtualmedia://10.20.47.100/redfish/v1/Systems/1"
    disableCertificateVerification: true
    credentialsName: "bmc-credentials"
  bootMACAddress: "d4:f5:ef:7f:b1:1c"
  online: true
  rootDeviceHints:
    hctl: "1:0:0:0"
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: assisted-deployment-pull-secret
  namespace: "r6-ocp-virt01"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: pull-secret-store
    kind: SecretStore
  target:
    name: assisted-deployment-pull-secret
    creationPolicy: Owner
  data:
  - secretKey: .dockerconfigjson
    remoteRef:
      key: pull-secret
      property: dockerconfigjson
---
apiVersion: hypershift.openshift.io/v1beta1
kind: HostedCluster
metadata:
  name: "r6-ocp-virt01"
  namespace: "r6-ocp-virt01"
  annotations:
    helm.sh/hook-weight: "20"
spec:
  release:
    image: "quay.io/openshift-release-dev/ocp-release:4.12.0-x86_64"
  platform:
    type: "Agent"
    agent:
      agentNamespace: "r6-ocp-virt01"
  dns:
    baseDomain: "example.com"
  networking:
    clusterNetwork:
    - cidr: 10.128.0.0/14
      hostPrefix: 23
    networkType: OVNKubernetes
    serviceNetwork:
      - cidr: "172.30.0.0/16"
  pullSecret:
    name: assisted-deployment-pull-secret
  sshKey:
    name: "r6-ocp-virt01-sshkey"
  services:
    - service: APIServer
      servicePublishingStrategy:
        type: LoadBalancer
        loadBalancer:
          hostname: "api.r6-ocp-virt01.example.com"
    - service: OAuthServer
      servicePublishingStrategy:
        type: Route
    - service: OIDC
      servicePublishingStrategy:
        type: Route
    - service: Konnectivity
      servicePublishingStrategy:
        type: Route
    - service: Ignition
      servicePublishingStrategy:
        type: Route
    - service: OVNSbDb
      servicePublishingStrategy:
        type: Route
---
apiVersion: agent-install.openshift.io/v1beta1
kind: InfraEnv
metadata:
  name: "worker"
  namespace: "r6-ocp-virt01"
  annotations:
    helm.sh/hook-weight: "10"
spec:
  osImageVersion: "4.12"
  sshAuthorizedKey: "ssh-rsa ..."
  pullSecretRef:
    name: assisted-deployment-pull-secret
  nmStateConfigLabelSelector:
    matchLabels:
      nmstate-cluster: "worker"
---
apiVersion: agent-install.openshift.io/v1beta1
kind: NMStateConfig
metadata:
  name: "r6-ocp-virt01-w03"
  namespace: "r6-ocp-virt01"
  annotations:
    helm.sh/hook-weight: "5"
  labels:
    nmstate-cluster: "worker"
spec:
  config:
    dns-resolver:
      config:
        server:
        - 10.20.47.157
        - 10.21.47.157
    interfaces:
    - ipv4:
        address:
        - ip: 10.20.184.13
          prefix-length: 24
        dhcp: false
        enabled: true
      ipv6:
        enabled: false
      link-aggregation:
        mode: 802.3ad
        port:
        - eno1np0
        - eno2np1
      mac-address: d4:f5:ef:7f:b1:1c
      name: bond0
      state: up
      type: bond
    - mac-address: d4:f5:ef:7f:b1:1c
      name: eno1np0
      state: up
      type: ethernet
    - mac-address: d4:f5:ef:7f:b5:34
      name: eno2np1
      state: up
      type: ethernet
    routes:
      config:
      - destination: 0.0.0.0/0
        next-hop-address: 10.20.184.1
        next-hop-interface: bond0
        table-id: 254
  interfaces:
    - name: "eno1np0"
      macAddress: "d4:f5:ef:7f:b1:1c"
    - name: "eno2np1"
      macAddress: "d4:f5:ef:7f:b5:34"
---
apiVersion: hypershift.openshift.io/v1beta1
kind: NodePool
metadata:
  name: "worker"
  namespace: "r6-ocp-virt01"
  annotations:
    helm.sh/hook-weight: "25"
spec:
  clusterName: "r6-ocp-virt01"
  release:
    image: "quay.io/openshift-release-dev/ocp-release:4.12.0-x86_64"
  replicas: 2
  management:
    upgradeType: InPlace
  platform:
    type: "Agent"
    agent:
      agentLabelSelector:
        matchLabels:
          infraenvs.agent-install.openshift.io: "worker"
  config:
---
apiVersion: batch/v1
kind: Job
metadata:
  name: patch-api-svc
  namespace: "r6-ocp-virt01"
  annotations:
    helm.sh/hook: post-install
    helm.sh/hook-weight: "5"
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      serviceAccountName: hypershift-installer
      containers:
        - name: patch-api-svc
          image: registry.redhat.io/openshift4/ose-cli:latest
          command:
            - bash
          args:
            - -c
            - |
              set -e
              
              # Wait for the API service to be available
              echo "Waiting for API service to be available..."
              oc wait --timeout=10m --for=condition=available service/kube-apiserver -n "r6-ocp-virt01-r6-ocp-virt01"
              
              # Get the MetalLB address pool name
              ADDRESS_POOL="<cluster-name>-api-address-pool"
              
              echo "Patching API service with MetalLB address pool: $ADDRESS_POOL"
              
              # Patch the service with MetalLB annotation
              oc patch service kube-apiserver \
                -n "r6-ocp-virt01-r6-ocp-virt01" \
                -p '{"metadata": {"annotations": {"metallb.universe.tf/address-pool": "'$ADDRESS_POOL'"}}}'
              
              echo "Successfully patched API service with MetalLB configuration"
              
              # Verify the patch was applied
              oc get service kube-apiserver -n "r6-ocp-virt01-r6-ocp-virt01" -o jsonpath='{.metadata.annotations.metallb\.universe\.tf/address-pool}'
              echo ""
          env:
            - name: KUBECONFIG
              value: "/secrets/kubeconfig"
          volumeMounts:
            - name: kubeconfig
              mountPath: "/secrets"
              readOnly: true
      restartPolicy: OnFailure
      volumes:
        - name: kubeconfig
          secret:
            secretName: "r6-ocp-virt01-admin-kubeconfig"
